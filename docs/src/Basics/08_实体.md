# 实体学习

- Cesium 中实体很重要
- Cesium 中实体很重要
- Cesium 中实体很重要

  实体（Entity）是 Cesium 中用于表示 动态时空对象 的核心概念，用于可视化点、线、面、模型、标签等对象，并支持时间动态属性和数据绑定

## 添加实体

- 使用`viewer.entities.add`添加实体

### 实体公共属性

| 属性名      | 类型       | 描述             |
| ----------- | ---------- | ---------------- |
| id          | String     | 实体的唯一标识符 |
| name        | String     | 实体的名称       |
| show        | Boolean    | 实体的可见性     |
| description | String     | 实体的描述信息   |
| position    | Cartesian3 | 实体的位置坐标   |
| orientation | Quaternion | 实体的朝向       |
| properties  | Object     | 实体的属性集合   |

### 实体类型

- 以下为全部实体类型,[官网传送门](https://cesium.com/learn/cesiumjs/ref-doc/Entity.html?classFilter=entity#.ConstructorOptions),

| 实体类型            | 描述                             |
| ------------------- | -------------------------------- |
| 点（Point）         | 要与此实体关联的点               |
| 线（Polyline）      | 要与此实体关联的多段线           |
| 多边形（Polygon）   | 要与此实体关联的多边形           |
| 模型（Model）       | 要与此实体关联的模型             |
| 广告牌（Billboard） | 要与此实体关联的公告板           |
| 箱（Box）           | 要与此实体关联的框               |
| 矩形（Rectangle）   | 要与此实体关联的矩形             |
| 椭圆（Ellipse）     | 要与此实体关联的椭圆             |
| 椭圆体（Ellipsoid） | 要与此实体关联的椭球体           |
| 标签（Label）       | 与此实体关联的标签               |
| 路径（Path）        | 要与此实体关联的路径             |
| 平面（Plane）       | 要与此实体关联的平面             |
| 墙（Wall）          | 要与此实体关联的墙               |
| 走廊（Corridor）    | 要与此实体关联的走廊             |
| 圆柱体（Cylinder）  | 要与此实体关联的圆柱体           |
| 瓦片集（Tileset）   | 要与此实体关联的 3D Tiles 图块集 |

## 点（Point）

`配置Options` :
| 属性 | 类型 | 默认值 | 描述 |
| --- | --- | --- | --- |
| color | Color | Color.WHITE | 点的填充颜色（支持 RGBA 透明度） |
| pixelSize | Number | 1 | 点的像素大小（屏幕空间固定尺寸） |
| outlineColor | Color | Color.BLACK | 点轮廓的颜色 |
| outlineWidth | Number | 0 | 点轮廓的宽度（像素） |
| heightReference | HeightReference | NONE | 高度参考模式：<br>• NONE - 绝对高度<br>• CLAMP_TO_GROUND - 贴地<br>• RELATIVE_TO_GROUND - 相对地面 |
| scaleByDistance | NearFarScalar | null | 根据相机距离缩放点大小 |
| translucencyByDistance | NearFarScalar | null | 根据相机距离调整透明度 |
| distanceDisplayCondition | DistanceDisplayCondition | null | 基于距离的显隐控制 |
| disableDepthTestDistance | Boolean | null | 用于指定要禁用深度测试的相机的距离 |
| show | Boolean | true | 是否显示点 |

[官网 options 介绍](https://cesium.com/learn/cesiumjs/ref-doc/PointGraphics.html#.ConstructorOptions)

### 基础实例

```js
const pointEntity = viewer.entities.add({
  position: Cesium.Cartesian3.fromDegrees(116.3975, 39.9075, 50),
  point: {
    color: Cesium.Color.RED.withAlpha(0.8), // 80% 不透明的红色
    pixelSize: 20, // 直径20像素
    outlineColor: Cesium.Color.WHITE, // 白色轮廓
    outlineWidth: 3, // 轮廓宽度3像素
    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND, // 贴地显示
    show: true, // 默认显示
  },
});
```

![点](./entityImg/pointEntity.png)

### 动态属性

1. 距离相关缩放 (scaleByDistance)

当相机靠近时点变大，远离时点变小

```js
pointEntity.point.scaleByDistance = new Cesium.NearFarScalar(
  1000, // 相机距离1000米时
  2.0, // 缩放至2倍大小
  5000, // 相机距离5000米时
  0.5 // 缩放至0.5倍大小
);
```

2. 距离相关透明度 (translucencyByDistance)

当相机靠近时透明度降低，远离时透明度升高

```js
pointEntity.point.translucencyByDistance = new Cesium.NearFarScalar(
  500, // 相机距离500米时
  1.0, // 完全不透明
  2000, // 相机距离2000米时
  0.2 // 20%透明度
);
```

3. 距离显隐控制 (distanceDisplayCondition)

相机距离 100-5000 米之间显示点

```js
pointEntity.point.distanceDisplayCondition =
  new Cesium.DistanceDisplayCondition(
    100, // 最小可见距离（米）
    5000 // 最大可见距离（米）
  );
```

### 高级技巧

1. 动态闪烁

该案例中 heightReference 不能设置为 CLAMP_TO_GROUND 贴地显示

```js
// 使用时间动态颜色实现闪烁
pointEntity.point.color = new Cesium.CallbackProperty(() => {
  const alpha = 0.5 + 0.5 * Math.sin(Date.now() / 500);
  return Cesium.Color.RED.withAlpha(alpha);
}, false);
```

2. 聚合大量点（Cluster）

```js
// 创建支持聚合的数据源
const clusteredDataSource = new Cesium.CustomDataSource("clusteredData");

// 添加到 Viewer
viewer.dataSources.add(clusteredDataSource);

// 启用聚合
clusteredDataSource.clustering.enabled = true;

// 配置聚合参数
clusteredDataSource.clustering.pixelRange = 48; // 聚合像素范围
clusteredDataSource.clustering.minimumClusterSize = 3; // 最小聚合点数

// 添加点实体
for (let i = 0; i < 1000; i++) {
  clusteredDataSource.entities.add({
    position: Cesium.Cartesian3.fromDegrees(
      116.3975 + Math.random() * 0.01, // 随机偏移
      39.9075 + Math.random() * 0.01, // 随机偏移
      50
    ),
    point: {
      pixelSize: 15,
      color: Cesium.Color.fromRandom(),
    },
    id: `point-${i}`,
  });
}
```

![聚合](./entityImg/clusterPoint.png)

## 线（Polyline）

`配置Options` :
| 属性 | 类型 | 默认值 | 描述 |
| --- | --- | --- | ----------- |
| show | Boolean | true | 是否显示线 |
| positions | PositionProperty | [] | 定义折线的顶点位置（Cartesian3 数组） |
| width | Number | 1.0 | 折线宽度（像素） |
| granularity | Number | Cesium.Math.RADIANS_PER_DEGREE | 折线的粒度（用于简化折线） |
| material | MaterialProperty | Color.WHITE | 折线的材质（颜色、纹理、特效等） |
| depthFailMaterial | MaterialProperty | null | 用于指定当多段线位于 terrain 下方时用于绘制多段线的材质 |
| arcType | ArcType | ArcType.GEODESIC | 线段类型：<br>• GEODESIC - 测地线（沿地球表面）<br>• RHUMB - 恒向线<br>• NONE - 直线 |
| clampToGround | Boolean | false | 是否贴地显示（需要地形数据） |
| shadows | ShadowMode | ShadowMode.DISABLED | 指定多段线是投射还是接收来自光源的阴影 |
| distanceDisplayCondition | DistanceDisplayCondition | null | 基于距离的显隐控制 |
| classificationType | ClassificationType | ClassificationType.BOTH | 指定折线应如何分类地形或 3D Tiles |
| zIndex | Number | 0 | 控制折线的绘制顺序 |

[官网 options 介绍](https://cesium.com/learn/cesiumjs/ref-doc/PolylineGraphics.html#.ConstructorOptions)

### 基础实例

```js
const positions = Cesium.Cartesian3.fromDegreesArray([
  116.3975,
  39.9075, // 北京
  121.4737,
  31.2304, // 上海
  114.1694,
  30.5812, // 武汉
]);

const polyline = viewer.entities.add({
  polyline: {
    positions: positions,
    width: 8,
    material: Cesium.Color.BLUE,
    arcType: Cesium.ArcType.GEODESIC, // 测地线
    clampToGround: true, // 贴地显示
  },
});
```
