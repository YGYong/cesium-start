# 防御圈雷达扫描效果

## 介绍

- 最近在做无人机飞入防御圈功能时，需要绘制雷达扫描效果，于是有了该案例
- 该案例展示了如何在三维地图上创建雷达扫描效果。结合了扇形扫描壁（wall）、半球体（ellipsoid），并通过时钟驱动实时旋转，适用于预警、监控范围可视化等场景。

<video controls width="600">
  <source src="../../Aassets/Practice/雷达扫描.mp4" type="video/mp4" />
  您的浏览器不支持HTML5视频标签。
</video>

## 功能

- 绘制雷达扫描扇形（wall）并随时间旋转，形成实时扫描动画。
- 显示覆盖范围的半球体（ellipsoid）作为视觉提示（半透明可选）。
- 支持通过参数快速调整位置（经纬度）、半径（米）、颜色与旋转速度。

## 可配置参数（示例）

- `centerLon` / `centerLat`：雷达中心经纬度
- `maxDistance`：扫描半径（单位：米）
- `color`：扫描颜色（CSS 字符串）
- `speed`：每次时钟 tick 的角度增量（度/帧）

## 核心代码片段

> 案例参考：https://github.com/jiawanlong/Cesium-Examples

### 1. 计算雷达扇形点位（关键函数）

```javascript
function calcRadarPoints(centerLon, centerLat, radius, heading) {
  const m = Cesium.Transforms.eastNorthUpToFixedFrame(
    Cesium.Cartesian3.fromDegrees(centerLon, centerLat),
  );
  const rx = radius * Math.cos((heading * Math.PI) / 180.0);
  const ry = radius * Math.sin((heading * Math.PI) / 180.0);
  const translation = Cesium.Cartesian3.fromElements(rx, ry, 0);
  const d = Cesium.Matrix4.multiplyByPoint(
    m,
    translation,
    new Cesium.Cartesian3(),
  );
  const c = Cesium.Cartographic.fromCartesian(d);
  const endLon = Cesium.Math.toDegrees(c.longitude);
  const endLat = Cesium.Math.toDegrees(c.latitude);

  return computeCircularFlight(centerLon, centerLat, endLon, endLat, 0, 90);
}
```

### 2. 生成扇形边缘点（用于 wall 的经纬度-高度数组）

```javascript
function computeCircularFlight(x1, y1, x2, y2, startAngle, sweepAngle) {
  const positionArr = [];
  positionArr.push(x1, y1, 0);

  const radius = Cesium.Cartesian3.distance(
    Cesium.Cartesian3.fromDegrees(x1, y1),
    Cesium.Cartesian3.fromDegrees(x2, y2),
  );

  for (let i = startAngle; i <= startAngle + sweepAngle; i++) {
    const h = radius * Math.sin((i * Math.PI) / 180.0);
    const r = Math.cos((i * Math.PI) / 180.0);
    const x = (x2 - x1) * r + x1;
    const y = (y2 - y1) * r + y1;
    positionArr.push(x, y, h);
  }
  return positionArr;
}
```

### 3. 创建示例雷达实体（wall + ellipsoid）

```javascript
function createSampleRadarFence() {
  const centerLon = 118.7969; // 南京
  const centerLat = 32.0603;
  const maxDistance = 5000; // 米
  const color = Cesium.Color.fromCssColorString("#ff3333");
  let heading = 0;
  let positionArr = calcRadarPoints(centerLon, centerLat, maxDistance, heading);

  const radarEntity = viewer.entities.add({
    position: Cesium.Cartesian3.fromDegrees(centerLon, centerLat, 0),
    wall: {
      positions: new Cesium.CallbackProperty(() => {
        return Cesium.Cartesian3.fromDegreesArrayHeights(positionArr);
      }, false),
      material: color.withAlpha(0.5),
    },
    ellipsoid: {
      radii: new Cesium.Cartesian3(maxDistance, maxDistance, maxDistance),
      material: color.withAlpha(0.2),
      outline: true,
    },
  });

  // 时钟驱动旋转动画
  viewer.clock.onTick.addEventListener(() => {
    heading += 4;
    if (heading >= 360) heading = 0;
    positionArr = calcRadarPoints(centerLon, centerLat, maxDistance, heading);
  });
}
```

## 完整代码

:::details 展开代码

```vue
<template>
  <div ref="cesiumContainer" class="container"></div>
</template>

<script setup>
import { ref, onMounted } from "vue";
import * as Cesium from "cesium";
const cesiumContainer = ref(null);
let viewer = null;
// 管理防御圈实体
let fenceEntities = [];

// 天地图TOKEN
const token = "05be06461004055923091de7f3e51aa6";

onMounted(() => {
  // 初始化Viewer
  viewer = new Cesium.Viewer(cesiumContainer.value, {
    geocoder: false, // 关闭地理编码搜索
    homeButton: false, // 关闭主页按钮
    sceneModePicker: false, // 关闭场景模式选择器
    baseLayerPicker: false, // 关闭底图选择器
    navigationHelpButton: false, // 关闭导航帮助
    animation: false, // 关闭动画控件
    timeline: false, // 关闭时间轴
    fullscreenButton: false, // 关闭全屏按钮
    baseLayer: false, // 关闭默认地图
  });
  // 清空logo
  viewer.cesiumWidget.creditContainer.style.display = "none";
  initMap();
  // 添加一个雷达扫描示例
  createSampleRadarFence();
});

// 计算雷达扫描的点位（参考开源代码实现）
// https://jiawanlong.github.io/Cesium-Examples/examples/cesiumEx/examples.html#mapping
const calcRadarPoints = (centerLon, centerLat, radius, heading) => {
  // 计算扫描线的终点
  const m = Cesium.Transforms.eastNorthUpToFixedFrame(
    Cesium.Cartesian3.fromDegrees(centerLon, centerLat),
  );
  const rx = radius * Math.cos((heading * Math.PI) / 180.0);
  const ry = radius * Math.sin((heading * Math.PI) / 180.0);
  const translation = Cesium.Cartesian3.fromElements(rx, ry, 0);
  const d = Cesium.Matrix4.multiplyByPoint(
    m,
    translation,
    new Cesium.Cartesian3(),
  );
  const c = Cesium.Cartographic.fromCartesian(d);
  const endLon = Cesium.Math.toDegrees(c.longitude);
  const endLat = Cesium.Math.toDegrees(c.latitude);

  // 计算扇形的点
  return computeCircularFlight(centerLon, centerLat, endLon, endLat, 0, 90);
};

// 计算圆弧飞行路径点
const computeCircularFlight = (x1, y1, x2, y2, startAngle, sweepAngle) => {
  const positionArr = [];

  // 中心点
  positionArr.push(x1, y1, 0);

  const radius = Cesium.Cartesian3.distance(
    Cesium.Cartesian3.fromDegrees(x1, y1),
    Cesium.Cartesian3.fromDegrees(x2, y2),
  );

  // 生成扇形边缘的点
  for (let i = startAngle; i <= startAngle + sweepAngle; i++) {
    const h = radius * Math.sin((i * Math.PI) / 180.0);
    const r = Math.cos((i * Math.PI) / 180.0);
    const x = (x2 - x1) * r + x1;
    const y = (y2 - y1) * r + y1;
    positionArr.push(x, y, h);
  }

  return positionArr;
};

// 添加一个模拟雷达扫描示例
const createSampleRadarFence = () => {
  if (!viewer) return;
  const centerLon = 118.7969; // 南京经度
  const centerLat = 32.0603; // 南京纬度
  const maxDistance = 5000; // 半径，单位米
  const cesiumColor = Cesium.Color.fromCssColorString("#ff3333");

  let heading = 0;
  let positionArr = calcRadarPoints(centerLon, centerLat, maxDistance, heading);

  const radarEntity = viewer.entities.add({
    id: `sample-radar`,
    name: `模拟雷达扫描`,
    position: Cesium.Cartesian3.fromDegrees(centerLon, centerLat, 0),
    wall: {
      positions: new Cesium.CallbackProperty(() => {
        return Cesium.Cartesian3.fromDegreesArrayHeights(positionArr);
      }, false),
      material: cesiumColor.withAlpha(0.5),
      outline: false,
    },
    ellipsoid: {
      radii: new Cesium.Cartesian3(maxDistance, maxDistance, maxDistance),
      maximumCone: Cesium.Math.toRadians(90),
      material: cesiumColor.withAlpha(0.2),
      outline: true,
      outlineColor: cesiumColor.withAlpha(0.6),
      outlineWidth: 1,
    },
  });
  fenceEntities.push(radarEntity);

  // 底部光环
  const circlePositions = [];
  const segments = 64;
  for (let i = 0; i <= segments; i++) {
    const angle = (i / segments) * Math.PI * 2;
    const dx = Math.cos(angle) * maxDistance;
    const dy = Math.sin(angle) * maxDistance;
    const lon =
      centerLon + dx / (111320 * Math.cos((centerLat * Math.PI) / 180));
    const lat = centerLat + dy / 111320;
    circlePositions.push(Cesium.Cartesian3.fromDegrees(lon, lat, 2));
  }

  const outerGlowCircleEntity = viewer.entities.add({
    id: `sample-nanjing-radar-circle`,
    name: `南京-雷达外环`,
    polyline: {
      positions: circlePositions,
      width: 12,
      material: new Cesium.PolylineGlowMaterialProperty({
        glowPower: 0.15,
        taperPower: 1.0,
        color: cesiumColor.withAlpha(0.6),
      }),
      clampToGround: true,
    },
  });
  fenceEntities.push(outerGlowCircleEntity);

  // 旋转动画
  viewer.clock.onTick.addEventListener(() => {
    heading += 4.0;
    if (heading >= 360) heading = 0;
    positionArr = calcRadarPoints(centerLon, centerLat, maxDistance, heading);
  });

  // 定位
  viewer.camera.lookAt(
    Cesium.Cartesian3.fromDegrees(centerLon, centerLat, 0),
    new Cesium.HeadingPitchRange(0, -30 * (Math.PI / 180), 20000),
  );
  // 取消绑定
  viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
};

// 加载天地图
const initMap = () => {
  // 以下为天地图及天地图标注加载
  const tiandituProvider = new Cesium.WebMapTileServiceImageryProvider({
    url:
      "http://{s}.tianditu.gov.cn/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=img&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles&tk=" +
      token,
    layer: "img",
    style: "default",
    format: "tiles",
    tileMatrixSetID: "w",
    subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"], // 子域名
    maximumLevel: 18,
    credit: new Cesium.Credit("天地图影像"),
  });

  // 添加地理标注
  const labelProvider = new Cesium.WebMapTileServiceImageryProvider({
    url:
      "http://{s}.tianditu.gov.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=cia&tileMatrixSet=w&tileMatrix={TileMatrix}&tileRow={TileRow}&tileCol={TileCol}&style=default&format=tiles&tk=" +
      token,
    layer: "img",
    style: "default",
    format: "tiles",
    tileMatrixSetID: "w",
    subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"], // 子域名轮询
    maximumLevel: 18,
    credit: new Cesium.Credit("天地图影像"),
  });
  // 天地图影像添加到viewer实例的影像图层集合中
  viewer.imageryLayers.addImageryProvider(tiandituProvider);
  // 天地图地理标注（后添加的会覆盖前面的）
  viewer.imageryLayers.addImageryProvider(labelProvider);
};
</script>
<style scoped>
.container {
  width: 100vw;
  height: 100vh;
}
</style>
```

:::
